# ubimqtt

Mqtt conveniecy library for using the Ubikampus Mqtt bus. Supports publishing
signed content on Mqtt (ES512 signatures only!), subscribing to content signed by a given keypair, and
subscribing to content signed by a known publisher whose public key can be found
on the Mqtt bus itself.

The signature format is JWS JSON, but the payload is unconventionally publised on Mqtt in the format output by
JSON.stringify() without Base64 encoding to keep string payloads human-readable on-the-wire.

Install using npm

~~~~
npm install ubimqtt
~~~~

Generate a keypair for testing

~~~~
mkdir -p ~/.private
# ES512
# private key
openssl ecparam -genkey -name secp521r1 -noout -out ~/.private/ubimqtt-testing-key.pem
# public key
openssl ec -in ~/.private/ubimqtt-testing-key.pem -pubout -out ~/.private/ubimqtt-testing-key-public.pem
~~~~

Example usage

~~~~
var UbiMqtt = require("ubimqtt");

var fs = require("fs");
var homedir = require('os').homedir();

var logger = console;


var privateKey= fs.readFileSync(homedir+"/.private/ubimqtt-testing-key.pem");
var publicKey= fs.readFileSync(homedir+"/.private/ubimqtt-testing-key-public.pem");

var mqtt = new UbiMqtt("mqtt://localhost:1883");

mqtt.connect(function(error)
    {
    if (error)
        logger.error(error);

    var onMessage = function(topic, message)
        {
        logger.log("Message received from mqtt server: {topic: \""+topic+"\",message: \""+message+"\"}");
        mqtt.disconnect(function(err)
            {
            if (!err)
                logger.log("Disconnected from Mqtt server");
            });
        };
    mqtt.subscribeSigned("test/test", publicKey, this, onMessage, function(err)
        {
        mqtt.publishSigned("test/test", "testmessage", null, privateKey, function(err)
            {
            if (!err)
                logger.log("Publication made");
            else
                logger.log("Publishing failed: "+err);
            });
        });
    });
~~~~

Do not edit this README.md file directly, it is autogenerated from the
template file README.hbs. Edit the template file README.hbs instead.

To generate this README.md file, execute:

npm run jsdoc

Api documentation
-----------------

<a name="UbiMqtt"></a>

## UbiMqtt
**Kind**: global class  

* [UbiMqtt](#UbiMqtt)
    * [new UbiMqtt(serverAddress, [options])](#new_UbiMqtt_new)
    * [.connect(callback)](#UbiMqtt+connect)
    * [.disconnect(callback)](#UbiMqtt+disconnect)
    * [.forceDisconnect(callback)](#UbiMqtt+forceDisconnect)
    * [.publish(topic, message, opts, callback)](#UbiMqtt+publish)
    * [.publishSigned(topic, message, opts, privateKey, callback)](#UbiMqtt+publishSigned)
    * [.subscribe(topic, obj, listener, callback)](#UbiMqtt+subscribe)
    * [.subscribeSigned(topic, publicKeys, obj, listener, callback)](#UbiMqtt+subscribeSigned)
    * [.subscribeFromPublisher(topic, publiserName, obj, listener, callback)](#UbiMqtt+subscribeFromPublisher)

<a name="new_UbiMqtt_new"></a>

### new UbiMqtt(serverAddress, [options])
Class for signed Mqtt communications at Ubikampus


| Param | Type | Description |
| --- | --- | --- |
| serverAddress | <code>string</code> | the Mqtt server to cennect to |
| [options] | <code>object</code> |  |
| [options.silent] | <code>boolean</code> | do not print logs |

<a name="UbiMqtt+connect"></a>

### ubiMqtt.connect(callback)
Connecs to the Mqtt server the address of which was given as a constructor parameter

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| callback | <code>function</code> | the callback to call upon connection or error |

<a name="UbiMqtt+disconnect"></a>

### ubiMqtt.disconnect(callback)
Disconnects from the Mqtt server

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| callback | <code>function</code> | the callback to call upon successful disconnection or error |

<a name="UbiMqtt+forceDisconnect"></a>

### ubiMqtt.forceDisconnect(callback)
Immediately disconnect without waiting for ACKs. If called before bus
connection is established, connection is canceled.

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| callback | <code>function</code> | called when disconnect succeeds |

<a name="UbiMqtt+publish"></a>

### ubiMqtt.publish(topic, message, opts, callback)
Publishes a message on the connected Mqtt server

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| topic | <code>string</code> | the Mqtt topic to publish to |
| message | <code>any</code> | the message to publish |
| opts | <code>object</code> | the options to pass to node-mqtt |
| callback | <code>function</code> | the callback to call upon success or error |

<a name="UbiMqtt+publishSigned"></a>

### ubiMqtt.publishSigned(topic, message, opts, privateKey, callback)
Publishes a signed message on the connected Mqtt server

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| topic | <code>string</code> | the Mqtt topic to publish to |
| message | <code>any</code> | the message to publish |
| opts | <code>object</code> | the options to pass to node-mqtt |
| privateKey | <code>string</code> | the private key in .pem format to sign the message with |
| callback | <code>function</code> | the callback to call upon success or error |

<a name="UbiMqtt+subscribe"></a>

### ubiMqtt.subscribe(topic, obj, listener, callback)
Subscribes to a Mqtt topic on the connected Mqtt server

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| topic | <code>string</code> | the Mqtt topic to subscribe to |
| obj | <code>any</code> | the value of "this" to be used whan calling the listener |
| listener | <code>function</code> | the listener function to call whenever a message matching the topic arrives |
| callback | <code>function</code> | the callback to be called upon successful subscription or error |

<a name="UbiMqtt+subscribeSigned"></a>

### ubiMqtt.subscribeSigned(topic, publicKeys, obj, listener, callback)
Subscribes to messages signed by particular keypair on a Mqtt topic on the connected Mqtt server

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| topic | <code>string</code> | the Mqtt topic to subscribe to |
| publicKeys | <code>Array.&lt;string&gt;</code> | the public keys of the keypairs the messages need to to be signed with. Only messages signed with these keypairs will invoke the listener |
| obj | <code>any</code> | the value of "this" to be used whan calling the listener |
| listener | <code>function</code> | the listener function to call whenever a message matching the topic and signed with the publicKey arrives |
| callback | <code>function</code> | the callback to be called upon successful subscription or error |

<a name="UbiMqtt+subscribeFromPublisher"></a>

### ubiMqtt.subscribeFromPublisher(topic, publiserName, obj, listener, callback)
Subscribes to messages on a Mqtt topic on the connected Mqtt server signed by a known publiser
The public key of the publiser is used for recognizing the messages originating from the publisher.
The public key of the publisher is fetched from the Mqtt topic publishers/publishername/publicKey
and kept up-to-date with the help of a regular Mqtt subscription

**Kind**: instance method of [<code>UbiMqtt</code>](#UbiMqtt)  

| Param | Type | Description |
| --- | --- | --- |
| topic | <code>string</code> | the Mqtt topic to subscribe to |
| publiserName | <code>string</code> | the name of the known publisher |
| obj | <code>any</code> | the value of "this" to be used whan calling the listener |
| listener | <code>function</code> | the listener function to call whenever a message matching the topic and signed with the publicKey arrives |
| callback | <code>function</code> | the callback to be called upon successful subscription or error |


* * *

&copy; 2019 University Of Helsinki
